import { Product } from "./types";

// Helper to generate a temp ID for initial list if needed locally
const uuid = () => crypto.randomUUID();

export const FIX_SQL = `
-- 1. التأكد من وجود الجداول الأساسية
create table if not exists products (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  price numeric,
  last_updated timestamptz default now(),
  is_review_requested boolean default false,
  review_batch_id text
);

create table if not exists orders (
  id uuid default gen_random_uuid() primary key,
  name text,
  items jsonb,
  profit_margin numeric default 0,
  delivery_cost numeric default 0,
  total_price numeric,
  created_at timestamptz default now()
);

-- جدول السجل التاريخي للأسعار (للنسخ الاحتياطي الذكي)
create table if not exists price_history (
  id uuid default gen_random_uuid() primary key,
  product_id uuid references products(id) on delete cascade,
  price numeric not null,
  recorded_date date default CURRENT_DATE,
  unique(product_id, recorded_date) -- يمنع تكرار السجل لنفس المنتج في نفس اليوم (يأخذ آخر تحديث)
);

-- تحديث الجدول لإضافة عمود التوصيل اذا كان غير موجود (مهم جداً للمستخدمين الحاليين)
alter table orders add column if not exists delivery_cost numeric default 0;

-- 2. تفعيل الأمان
alter table products enable row level security;
alter table orders enable row level security;
alter table price_history enable row level security;

-- 3. منح الصلاحيات
grant all on table products to anon, authenticated, service_role;
grant all on table orders to anon, authenticated, service_role;
grant all on table price_history to anon, authenticated, service_role;

-- 4. تنظيف السياسات القديمة
drop policy if exists "Enable all access for all users" on products;
drop policy if exists "Public Access" on products;
drop policy if exists "allow_all" on products;
drop policy if exists "Enable all orders access" on orders;
drop policy if exists "Enable all access" on price_history;

-- 5. إنشاء سياسات شاملة
create policy "Enable all access for all users" on products for all using (true) with check (true);
create policy "Enable all orders access" on orders for all using (true) with check (true);
create policy "Enable all history access" on price_history for all using (true) with check (true);
`;

export const INITIAL_DATA_RAW = `
ProductName | اسم_المنتج	BasePrice | سعر_الجملة
ارز ابيض تعبئه كيلو	3000
ارز اصفر 20 كيلو جوال	44000
ارز ابيض25 كيلو جوال	65000
ارز اصفر 5 كيلو جوال	20000
ارز اصفر تعبئه كيلو	2500
ارز السلام بسمتي كيلو	8000
ارز الفراشة كيلو	4000
ارز الفراشه 10 كيلو بكت	38000
ارز الفراشه 10 كيلو اصفر بكت	
ارز بسمتي نص كيلو	
ارز تاج محل بسمتي كيلو	
ارز تاج محل بسمتي نص	
اقلام بيك اصليه باكو	
اقلام بيك اصليه دسته	
اقلام رصاص عادية دستة	
اقلام رصاص مبرية دستة	
اقلام رصاص مبريه باكو	
المهلب باكنج باودر صندوق	7000
نشا تعبئة كيلو	7000
اناناس الوابل كبير علبة	7000
اناناس المدينه صغير علبه	
اندومي مصريه كرتونة 48 حبه	32000
اوفلتين 400جرام علبة	10000
باكنج باودر كيلو	7000
باكنج باودر الصقر صندوق	
باكنج باودر سعودي علبة	
بامبرز الوابل مقاس 1 باكو	
بامبرز الوابل مقاس 3 باكو	
بامبرز باريس مقاس 3 بكت	
بامبرز باريس مقاس 4 بكت	
بامبرز فاين بيبي مقاس 2 3 4 بكت 58 قطعه	33000
بسكويت اروي كرتونة	13500
بسكويت الشريف كرتونة	14500
بسكويت الفتح اصفر كرتونة	
بسكويت الفتح حليب كرتونة	
بسكويت الفتح فاخر كرتونة	
بسكويت اوريو باكو	
بسكويت بركة كرتونة	
بسكويت تيك توك باكو	
بسكويت جلكوز كرتونة	14000
بسكويت دايجستف كرتونة	
بسكويت ديمة كرتونة	20000
بسكويت شاي تيفو كرتونه	
بسكويت كريمتي صغير كرتونة	
بسكويت كريمتي كبير كرتونة	
بسكويت ماجد كرتونه	15000
بسكويت معمول بالتمر باكو	
بسكويت هبه فاخر كرتونه	
بسكويت هيرو كرتونة	
بسلة علبة	4500
بصل  كسلا كيله	11000
بطاطس مجمدة 1كيلو كيس	
بطاطس مجمدة 2كيلو ونص كيس	
بلح بركاوي ملوة	20000
بن اسراء ربع	
بن كنغو رطل	9000
تونه واحد قطعه	6000
تونة علبة	2500
ثوم دنقلا رطل	
ثوم صيني رطل	7000
جبنة اسلايت 10قطع	
جبنة بلوك شيدر نص كيلو	
جبنة بيضاء كيلو	
جبنه سائلة نص كيلو	
جبنه سائله 300جرام	
جبنه صوص شيدر 300جرام	
جبنه صوص شيدر كيلو	
جبنه صوص شيدر نص	
جبنه صوص شيدر تقيله منازل نص	
جبنه لباشكري الوابل علبة	
جبنه مضفره كيلو	
جبنه موزريلا كيلو	
جبنه موزريلا مثلثات مثلث	
جلاد بلاستيك شفاف 12حبه ظرف	
جلاد بلاستيك ملون جراب 10حبات ظرف	
جلاد ورق بني 50 حبة	
جنزبيل رطل	8000
جوزهند كيلو	22000
حجر بطارية باكو	
حلاة بقرة الشمج  كيس 	20000
حلاوة بقرة الشمج كراميل كيس	
حلاوة تيك توك علب	
حلاوة قنبلة صندوق	
حلاوة قهوة علبة	
حلاوة مصاصة تايغر بوب كيس	8000
حلبة رطل هندية	5000
خل تفاح زجاجه	
خل كبير باغة	4000
خميرة شريط دستة	3500
دقيق 25 كيلو راس الثور جوال	47000
دقيق زادنا كيلو بكت	24000
دقيق زادنا بكت	
دقيق سمولينا  لمتنا بكت مصريه كيلو	27000
دقيق سيقا بكت	23000
دقيق سيقا  سمولينا كيلو	35000
دقيق مخصوص بكت	35000
دقيق مخصوص كيلو	
دقيق مصري 25 كيلو زينه جوال	49000
زبادي نص كيلو	
زبادي كيلو	
زبدة 500 جرام اصيل	10000
زمزمية عادية كبيرة حبة	
زمزمية مصاصة حبة	
زيت طعام حياة 750 كرستالة	
زيت ابيض 18رطل زولا باقة	
زيت الطيب 4لتر كرستاله	
زيت زيتون قزازة المدينة	5000
زيت شمس 1لتر كرستالة	8000
زيت شمس 4 لتر كرستاله	
زيت تركي 4لتروربع كرستالة	30000
زيت صباح1 لتر كرستالة	8000
زيت فول 18رطل جركانة	73000
زيتون شرائح كيلو	22000
زيتون عادي كيلو	22000
سكر 10 كيلو جوال	31000
سكر 5 كيلو جوال	16000
سكر 50 كيلو جوال	152000
سكسكانيه كيس	
سكسكانيه كرتونه نوبو	35000
سمبوسه كيلو	
سمن بلدي نص كيلو	
سوبر جل بشري علبة	
شاي الغزالتين رطل	16000
شاي الغزالتين نص رطل	8000
شاي الواحة رطل	15000
شاي الواحة نص رطل	7500
شاي رتش رطل	
شاي نبتة رطل	
شريط حنه احمر/ اصفر /اسود دستة	
شطة حارة زجاج زجاجة	
شطة حمراء رطل	6000
شعير سعودي قزاز	
شعيرية دبي كيس	
شعيرية نوبو كيس	
شعيرية نوبو كرتونة 30 كيس	35000
شوفان علبة	
شوكولاتة ماكستيلا جردل	15000
شوكولاتة باونتي باكو	
شوكولاتة تاتاو صغيرة باكو	
شوكولاتة تاتاو كبيرة باكو	
شوكولاتة كت كات باكو	
شوكولاتة ماربيلا باكو	
شوكولاتة ماندولين باكو	
شوكولاته بيضه باكو	
شوكولاته تويكس باكو	
شوكولاته ماريو باكو	
شوكولاته معجون باكو	
شيبس انكل بطاطس جامبو كرتونة	
شيبس انكل بطاطس وسط كرتونة	
شيبس انكل صغير كرتونه	
شيبسي نايس كرتونه	
صابون بدرة 2 جوري كيلو جوال	10000
صابون بدرة 3 جوري كيلو جوال	15000
صابون بدرة 1كيلو اجوري جوال	5000
صابون بدرة 1كيلو فاب	5000
صابون بدرة3كيلو فاب جوال	15000
صابون بدرة وشينو 1كيلو جوال	
صابون بدرة وشينو 2كيلو جوال	
صابون بدرة وشينو نص كيلو كيس	
صابون بشرى جردل	15000
صابون بشرى اوتومتك 2.5كيلو صندوق	1165
صابون بشرى صغير علبة	
صابون بشري وسط علبه	4000
صابون بودره الدولار 5 كيلو جوال	
صابون بودره فريش 3كيلو جوال	
صابون توب 75 جرام دستة	
صابون جلسرين 150جرام دستة	
صابون جولي 125 جرام دستة	
صابون حمام بالموليف 175جرام دستة	
صابون حمام لوكس  وسط دسته	25000
صابون ديتول دستة	
صابون سافنا 120جرام دستة	
صابون سائل مارفل كرستاله	
صابون صوفت 125 جرام دستة	
صابون صوفت 75جرام دستة	
صابون غسيل 120 جرام الدولار كرتونه	
صابون غسيل 130ج شريحتين كرتونة	
صابون غسيل 160 ج كرتونه	
صابون غسيل 200 جرام كرتونة	
صابون فاء 125جرام دستة	
صابون فاء 175جرام دستة	
صابون فابي 1 كيلو كيس	
صابون فاب 2 كيلو كيس	
صابون فاب سايل حمامات باقة	
صابون فاب نص كيس	
صابون لايفوي هندي 120 دستة	
صابون لوكس 85جم دسته	
صلصة البستان علبة	4000
صلصة الفراشة ظرف باكو	10000
صلصه 	
طحنية 2 كليو المشرقه جردل	20000
طحنية 1كيلو المشرقة جردل	10000
طحنية 3كيلو المشرقة جردل	30000
طحنية 5 كيلو المشرقة جردل	40000
طحنية اروى صباعات باكو	
طحنيه 1 كيلو شوكولاته جردل	
طحنيه 10 كيلو المريومابي جردل	
طحنيه 10 كيلو كريمتي جردل	
طحنيه 15 كيلو اروي جردل	
طحنيه 15 كيلو كريمتي جردل	
طحنيه ربع كيلو جردل	
طحنيه نص كيلو شكولاتة جردل	
طحينة علبة	
طين صلصال حبة	
ظهرة فالكون كيلو	4000
عدس الفراشه كيلو	5000
عدسية ملوة	12000
عرديب رطل	6000
عصير اروى كيس	2500
عصير روزانا علبه	7000
عصير فالي كيس	2500
عصير فيمتو زجاجه	
عصير لارينا كيس	2500
عطرون رطل	8000
فازلين صغير دسته	
فاصوليا كيلو	8000
فانليا علبة	1000
فانليا دسته	12000
فرش اسنان خشنة دستة	5000
فرش أسنان ناعمة دستة	5000
فلايتكس حبه	
فلفل رطل	20000
فنكوش كيلو	
فول استرالي ملوة	
فول حبشي حبه وسط ملوه	17000
فول سيوبر وسط ملوه	25000
فول	
قرفة رطل	8000
قرنجال رطل	8000
قرنفل  رطل	
قشطة علبة	3000
قمردين لفه	
قنقليز ملوه	20000
كاتشب زجاجة	4000
كاتشب الفراشة باكو	
كاتشب المدينة علبة	
كاستر كيلو	7000
كاستر علبة	
كاستر صندوق كرتونه	8000
كبكبي ملوه	25000
كراس انجليزي كبير دسته	
كراس حساب صغير دسته	
كراس حساب كبير دسته	
كراس صغير انجليزي دستة	
كراس صغير عربي دستة	
كراس صغير عربي دستة	
كراس صغير هندسة دستة	
كراس عربي كبير دستة	10000
كراس هندسه كبير دسته	
كربونات باكو	7000
كركدي رطل	6000
كسبرة رطل	6000
كيك لينا فاخر كرتونة	14000
كيك فتح المجيد عادي كرتونة	
كيك فتح المجيد فاخر كرتونة	
لبن الوابل 1 كيلو كيس	
لبن لابي 1 كيلو كيس	
لبن نيدو 1 كيلو ونص كيس	
لبن كابو 1 كيلو كيس	30000
لبن وزن كيلو	24000
ماجي مصري صندوق	
ماكستيلا جردل	
مايونيز وسط علبة	11000
مخلل كيلو	
مربى المدينة علبة صغيرة	
مربى المدينة كبيرة علبة	
مربى ابو سيفين وسط علبة	5000
مربى ابو سيفين كبيرة علبة	10000
مربى ابو سيفين صغيرة علبة	3000
مربي حلواني كبيره علبه	
مربي سعيد وسط علبة	
مرقة كنور كبيرة باكو ظروف	20000
مش البوادي صغير علبه	
مش البوادي كبير علبه	
مشط شعرصغير ملون شر	
معجون سجنال كبير حبة	4000
معجون سيجنال وسط حبه	2500
معجون كلوس اب كبير	4500
مكرونة 10 كيلو الوسام جوال	
مكرونة ادم كرتونة	
مكرونة نوبو كرتونة	3500
مكرونة 4 كيلو بدور جوال	16000
مكرونه 10 كيلو ابو سيفين جوال	
مكرونه 7 كيلو جوال	
ملح ساسا علبة	
ملح كيس 1 كيلو كيس	1000
مناديل فاين باكو صغيرة دسته	3000
نسكافي  علبة صغير	10000
نسكافي 3*1 مصري باكو	
نسكافي كبايه باكو	
نسكافي كبير 230 جرام علبة	
نشادر كيلو	12000
نشأ كيلو	7000
`;

export const parseInitialData = (): Omit<Product, 'id'>[] => {
  const lines = INITIAL_DATA_RAW.trim().split('\n');
  const products: Omit<Product, 'id'>[] = [];
  
  // Skip header
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Split by tab or multiple spaces if tab isn't present
    // The raw data uses tabs in the prompt description
    const parts = line.split('\t');
    
    if (parts.length >= 1) {
      const name = parts[0].trim();
      let price: string | number = '';
      
      if (parts.length > 1) {
        const priceRaw = parts[1].trim();
        // Remove commas if any, ensure it's a number string
        if (priceRaw && !isNaN(Number(priceRaw.replace(/,/g, '')))) {
           price = Number(priceRaw.replace(/,/g, ''));
        } else {
           price = '';
        }
      }
      
      products.push({
        name,
        price,
        is_review_requested: false,
        review_batch_id: null
      });
    }
  }
  return products;
};